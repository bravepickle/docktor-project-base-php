# -*- mode: ruby -*-
# vi: set ft=ruby :

vm_name = "Docker Master"
vm_root = "/var/www"
vm_ip = "192.168.33.211"
vm_host = "docktor-master"

Vagrant.configure(2) do |config|
  config.vm.box_url = "file:///var/www/docktor/docktor-master-test/packer_vmware-iso_vmware.box"
  #config.vm.box_url = "https://atlas.hashicorp.com/zig-zag/docktor-master-test"
  config.vm.box = "zig-zag/docktor-master-test" # TODO: replace with own box
  config.vm.box_check_update = true

  config.vm.hostname = vm_host
  config.vm.boot_timeout = 720
  config.vm.post_up_message = "Add to /etc/hosts line: #{vm_ip} #{vm_host}"

  config.vm.network "private_network", ip: vm_ip

  # VMWare-specific settings
  config.vm.provider "vmware_fusion" do |v, override|
    #v.gui = true
    v.vmx["memsize"] = "2048"
    v.vmx["numvcpus"] = "2"
    v.vmx["displayname"] = vm_name

    # No need for NFS for VMWARE
    override.vm.synced_folder "../data/www", vm_root
  end

  # copy files from host to guest
  config.vm.provision "file", source: "~/.gitconfig", destination: ".gitconfig"
  config.vm.provision "file", source: "~/.ssh/id_rsa.pub", destination: "/tmp/host_id_rsa.pub"

  # init docker and setup environment
  config.vm.provision "shell", path: "../bin/init_docker_master.sh"

  config.vm.synced_folder ".", "/vagrant", disabled: true # disable syn to "/vagrant" folder

  # puppet provision
  config.vm.provision "puppet" do |puppet|
    puppet.manifests_path = "puppet"
    puppet.manifest_file = "docker_master.pp"
    puppet.hiera_config_path = "puppet/hiera.yaml"
    #puppet.working_directory = "/tmp/vagrant-puppet"
  end

  config.push.define "atlas" do |push|
    push.app = "zig-zag/docktor-master-test"
    push.vcs = true
    push.dir = "private/docktor-master-test"
  end
end
